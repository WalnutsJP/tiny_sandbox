<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Sandbox</title>

    <!-- PyScript ã®å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <!-- CoddeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css" />

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>

    <!-- p5.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>

    <style>
        *, *::before, *::after {
           box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0 auto;
            padding: 10px;
        }

        h1 {
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 0px 11px;
            padding: 0;
        }

        .main-container {
            display: flex;
            margin: 0px 0;
            height: 100%;
        }

        .left-panel {
            flex: 1;
            min-width: 0;
            border: 1.5px solid #3c3c3c;
            border-right-width: 1px;
            border-radius: 5px 0px 0px 5px;
            padding: 10px;
            margin: 0;
        }
        .right-panel {
            flex: 1;
            min-width: 0;
            border: 1.5px solid #3c3c3c;
            border-left-width: 1px;
            border-radius: 0px 5px 5px 0px;
            padding: 10px;
            margin: 0;
        }

        .tab-container {
            display: flex;
            border-bottom: 2px solid #007acc;
            margin-bottom: 10px;
        }

        .tab-button {
            border: none;
            border-top: 2px solid transparent;
            border-radius: 5px 5px 0 0;
            padding: 10px 15px;
            background-color: #f0f0f0;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #007acc;
            color: white;
        }
        .tab-button:hover:not(.active) {
            background-color: #e0e0e0;
        }

        .CodeMirror {
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            width: 100%;
            height: 500px;
            font-family: 'Consolas', 'Monaco', 'Courier New', Courier, monospace;
            font-size: 14px;
        }

        .execute-btn {
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            background-color: #007acc;
            color: white;
            cursor: pointer;
        }
        .execute-btn:hover {
            background-color: #005a9e;
        }

        .output-container {
            margin-top: 12px;
            background-color: #f9f9f9;
            overflow: hidden;
        }

        .code-output {
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            padding: 10px;
            margin: 5px 0;
            background-color: #1e1e1e;
            /*height: 500px;*/
            min-height: 120px;
            max-height: 160px;
            font-family: 'Consolas', 'Monaco', 'Courier New', Courier, monospace;
            font-size: 14px;
            color: #d4d4d4;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        .code-output::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        .code-output::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 6px;
        }
        .code-output::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        .results-area {
            margin-top: 0px;
            max-height: 600px;
            overflow-y: auto;
        }

        .results-div {
            margin: 0px 0;
            padding: 10px;
            border: 1px solid #3c3c3c;
            border-radius: 5px;
            background: #fff;
        }

        .glsl-canvas {
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: #000;
            width: 100%;
            max-width: 512px;
            height: 512px;
        }
    </style>
</head>
<body>
    <py-config>
        packages = ["numpy", "matplotlib", "Pillow"]
    </py-config>
    <h1>Tiny Sandbox</h1>
    <div class="main-container">
        <div class="left-panel">
            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ-->
            <div class="tab-container">
                <button class="tab-button active" id="python-tab">ğŸ Python</button>
                <button class="tab-button" id="glsl-tab">ğŸ¨ GLSL</button>
                <button class="tab-button" id="p5-tab">ğŸ«Ÿ P5.js</button>
            </div>

            <!-- Pythonç”¨ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚¨ãƒªã‚¢-->
            <textarea id="python-code-input" style="display: none;"></textarea>

            <!-- GLSLç”¨ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚¨ãƒªã‚¢-->
            <textarea id="glsl-code-input" style="display: none;"></textarea>

            <!-- P5ç”¨ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚¨ãƒªã‚¢-->
            <textarea id="p5-code-input" style="display: none;"></textarea>
        </div>
        <div class="right-panel">
            <button id="execute-btn" class="execute-btn">å®Ÿè¡Œ</button>
            <div class="output-container">
                <div id="code-output" class="code-output">å®Ÿè¡ŒçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
                <div id="results-area" class="results-area"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ¼ãƒ‰å®šç¾© -->
    <script src="init-code.js"></script>

    <!-- CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿åˆæœŸåŒ–-->
    <script>
        /**
         * Tabã‚­ãƒ¼ã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ 
         * @param {CodeMirror} cm CodeMirrorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
         */
        function onTabKey(cm) {
            // é¸æŠä¸­ã®è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ 
            if (cm.somethingSelected()) {
                cm.indentSelection('add');
            }
            // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«ã‚¹ãƒšãƒ¼ã‚¹4ã¤ã‚’æŒ¿å…¥
            else {
                const indentUnit = cm.getOption("indentUnit");
                const spaces = " ".repeat(indentUnit);
                cm.replaceSelection(spaces);
            }
        }

        /**
         * Shift+Tabã‚­ãƒ¼ã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’å‰Šé™¤
         * @param {CodeMirror} cm CodeMirrorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
         */
        function onShiftTabKey(cm) {
            // é¸æŠä¸­ã®è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’å‰Šé™¤
            if (cm.somethingSelected())
            {
                cm.indentSelection('subtract');
            }
            else {
                // â‘¡ é¸æŠãŒç„¡ã„å ´åˆ â†’ ç¾åœ¨è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’1æ®µéšæˆ»ã™
                const cursor = cm.getCursor();
                const lineNumber = cursor.line;
                const lineContent = cm.getLine(lineNumber);

                const indentUnit = cm.getOption("indentUnit");

                // è¡Œé ­ã®ç©ºç™½ã‚’å–å¾—
                const leadingSpaces = lineContent.match(/^\s*/)[0].length;

                if (leadingSpaces > 0) {
                    // æ¸›ã‚‰ã™é‡ï¼ˆindentUnitåˆ†ã€ãŸã ã—ä¸è¶³ã—ãªã„ã‚ˆã†ã«ï¼‰
                    const removeCount = Math.min(indentUnit, leadingSpaces);

                    cm.replaceRange(
                        '',
                        { line: lineNumber, ch: 0 },
                        { line: lineNumber, ch: removeCount }
                    );
                }
            }
        }

        window.runP5Code = function(width, height, userCode) {
            const resultsArea = document.querySelector("#results-area");
            resultsArea.innerHTML = "";

            // ã‚³ãƒ³ãƒ†ãƒŠdivã‚’ä½œæˆ
            const div = document.createElement("div");
            div.className = "results-div";
            resultsArea.appendChild(div);

            try {
                // p5ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
                new p5(function(p) {
                    try {
                        const fn = new Function('p', `
                            with(p) {
                                ${userCode}
                                // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’pã«ç™»éŒ²
                                if (typeof setup !== 'undefined') p.setup = setup;
                                if (typeof draw !== 'undefined') p.draw = draw;
                                if (typeof mousePressed !== 'undefined') p.mousePressed = mousePressed;
                                if (typeof keyPressed !== 'undefined') p.keyPressed = keyPressed;
                            }
                        `);
                        fn(p);
                    } catch(e) {
                        p.background(30);
                        p.fill(255, 80, 80);
                        p.noStroke();
                        p.textSize(14);
                        p.text("Error: " + e.message, 10, 30);
                        p.noLoop();
                    }
                }, div);
                return { success: true };
            } catch(e) {
                return { success: false, message: e.message };
            }
        };

        // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè¨€èª
        let currentLaunguage = 'python';

        // åˆæœŸè¨€èªçŠ¶æ…‹ã‚’dataå±æ€§ã¨ã—ã¦è¨­å®š
        document.body.setAttribute('data-current-language', currentLaunguage);

        // CodeMirrorã®å…±é€šã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const EDITOR_BASE_OPTIONS = {
            theme: 'monokai',
            lineNumbers: true,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            extraKeys: {
                'Tab': onTabKey,
                'Shift-Tab': onShiftTabKey
            }
        };

        // Pythonç”¨CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‚’åˆæœŸåŒ–
        var pythonEditor = CodeMirror.fromTextArea(document.getElementById('python-code-input'), {
            ...EDITOR_BASE_OPTIONS,
            mode: 'python',
        });

        // GLSLç”¨CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‚’åˆæœŸåŒ–
        var glslEditor = CodeMirror.fromTextArea(document.getElementById('glsl-code-input'), {
            ...EDITOR_BASE_OPTIONS,
            mode: 'x-shader/x-fragment',
        });

        // P5ç”¨CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‚’åˆæœŸåŒ–
        var p5Editor = CodeMirror.fromTextArea(document.getElementById('p5-code-input'), {
            ...EDITOR_BASE_OPTIONS,
            mode: 'javascript',
        });

        // åˆæœŸçŠ¶æ…‹ã§GLSLã‚¨ãƒ‡ã‚£ã‚¿ã‚’éè¡¨ç¤º
        glslEditor.getWrapperElement().style.display = 'none';
        p5Editor.getWrapperElement().style.display = 'none';

        // å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
        if (typeof window.INIT_PYTHON_CODE !== 'undefined') {
            pythonEditor.setValue(window.INIT_PYTHON_CODE);
        } else {
            console.warn('INIT_PYTHON_CODE ãŒæœªå®šç¾©ã§ã™ã€‚init-code.js ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        if (typeof window.INIT_GLSL_CODE !== 'undefined') {
            glslEditor.setValue(window.INIT_GLSL_CODE);
        } else {
            console.warn('INIT_GLSL_CODE ãŒæœªå®šç¾©ã§ã™ã€‚init-code.js ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        if (typeof window.INIT_P5_CODE !== 'undefined') {
            p5Editor.setValue(window.INIT_P5_CODE);
        } else {
            console.warn('INIT_P5_CODE ãŒæœªå®šç¾©ã§ã™ã€‚init-code.js ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function switchLanguage(language) {
            currentLaunguage = language;
            // ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ã‚‚ä¿å­˜
            document.body.setAttribute('data-current-language', language);

            // é¸æŠè¨€èªã«å¿œã˜ã¦è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('python-tab').classList.toggle('active', language === 'python');
            document.getElementById('glsl-tab').classList.toggle('active', language === 'glsl');
            document.getElementById('p5-tab').classList.toggle('active', language === 'p5');
            pythonEditor.getWrapperElement().style.display = language === 'python' ? 'block' : 'none';
            glslEditor.getWrapperElement().style.display = language === 'glsl' ? 'block' : 'none';
            p5Editor.getWrapperElement().style.display = language === 'p5' ? 'block' : 'none';

            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
            console.log(`è¨€èªåˆ‡ã‚Šæ›¿ãˆ: ${language}`);

            // ã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            setTimeout(() => {
                if (language === 'python') {
                    pythonEditor.refresh();
                } else if(language === 'glsl') {
                    glslEditor.refresh();
                } else {
                    p5Editor.refresh();
                }
            }, 100);
        }

        // ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('python-tab').addEventListener('click', () => switchLanguage('python'));
        document.getElementById('glsl-tab').addEventListener('click', () => switchLanguage('glsl'));
        document.getElementById('p5-tab').addEventListener('click', () => switchLanguage('p5'));

        // PyScriptã§ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
        window.pythonEditor = pythonEditor;
        window.glslEditor = glslEditor;
        window.p5Editor = p5Editor;
        window.currentLaunguage = currentLaunguage; // åˆæœŸè¨€èªçŠ¶æ…‹ã‚‚ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š

        console.log('âœ… CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
    </script>

    <!-- GLSLå®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³ -->
    <script>
        class GLSLEngine {
            constructor() {
                this.canvas = null;             // Canvas
                this.gl = null;                 // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
                this.program = null;            // GLSLãƒ—ãƒ­ã‚°ãƒ©ãƒ 
                this.startTime = Date.now();    // å®Ÿè¡Œé–‹å§‹æ™‚é–“
                this.frameCount = 0;            // å®Ÿè¡Œãƒ•ãƒ¬ãƒ¼ãƒ æ•°
                this.animationId = null;        // æ¬¡ã®æç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã®ID
                
                // @Memo: ShaderToyã®iMouseã®æŒ™å‹•ã¯ä»¥å‰ã¯LMBéæŠ¼ä¸‹æ™‚ã¯iMouse.zwã«0ãŒæ¸¡ã•ã‚Œã¦ã„ãŸãŒ
                // ç¾åœ¨ã¯ä»¥ä¸‹ã«å¤‰æ›´ã•ã‚Œã¦ãŠã‚Šã€LMBæŠ¼ä¸‹é–‹å§‹ã‹ã©ã†ã‹ã‚’ã‚·ã‚§ãƒ¼ãƒ€ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹
                // iMouse.xy : æœ€å¾Œã«LMBæŠ¼ä¸‹ã—ãŸåº§æ¨™
                // iMouse.z  : æœ€åˆã«LMBæŠ¼ä¸‹ã—ãŸXåº§æ¨™ã®çµ¶å¯¾å€¤ * (æŠ¼ä¸‹ä¸­ã‹ ? 1 : -1)
                // iMouse.w  : æœ€åˆã«LMBæŠ¼ä¸‹ã—ãŸYåº§æ¨™ã®çµ¶å¯¾å€¤ * (æŠ¼ä¸‹é–‹å§‹ã‹ ? 1 : -1)
                // https://www.shadertoy.com/view/Mss3zH
                this.mouse = {
                    x: 0,               // æœ€å¾Œã«LMBæŠ¼ä¸‹ã—ãŸXåº§æ¨™
                    y: 0,               // æœ€å¾Œã«LMBæŠ¼ä¸‹ã—ãŸYåº§æ¨™
                    lx: 0,              // æœ€åˆã«LMBæŠ¼ä¸‹ã—ãŸXåº§æ¨™
                    ly: 0,              // æœ€åˆã«LMBæŠ¼ä¸‹ã—ãŸYåº§æ¨™
                    isDown: false,      // ç¾ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚ã®LMBæŠ¼ä¸‹ä¸­ãƒ•ãƒ©ã‚°
                    isPrevDown: false,  // å‰ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚ã®LMBæŠ¼ä¸‹ä¸­ãƒ•ãƒ©ã‚°
                };

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å‚ç…§ã‚’ä¿æŒï¼ˆcleanupæ™‚ã«è§£é™¤ã™ã‚‹ãŸã‚ï¼‰
                this._onMouseMove  = null;
                this._onMouseDown  = null;
                this._onMouseUp    = null;
                this._onMouseLeave = null;
            }

            /**
             * @brief ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³» (å·¦ä¸‹åŸç‚¹ãƒ»Yä¸Šå‘ã) ã¸å¤‰æ›
             *        WebGLãŠã‚ˆã³Shadertoyã¯Yè»¸ãŒä¸‹ã‹ã‚‰ä¸Šãªã®ã§åè»¢ãŒå¿…è¦
             */
            _toGLCoords(clientX, clientY) {
                const rect = this.canvas.getBoundingClientRect();
                // CSSè¡¨ç¤ºã‚µã‚¤ã‚ºã¨ãƒãƒƒãƒ•ã‚¡è§£åƒåº¦ã®ã‚¹ã‚±ãƒ¼ãƒ«æ¯”
                const scaleX = this.canvas.width  / rect.width;
                const scaleY = this.canvas.height / rect.height;
                const x =  (clientX - rect.left) * scaleX;
                const y = this.canvas.height - (clientY - rect.top) * scaleY;
                return { x, y };
            }

            /**
             * @breaf åˆæœŸåŒ–å‡¦ç†
             */
            init(width = 512, height = 512) {
                // æ—¢å­˜ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
                this.cleanup();

                // æ–°ã—ã„ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
                this.canvas = document.createElement('canvas');
                this.canvas.width = width;
                this.canvas.height = height;
                this.canvas.className = 'glsl-canvas';

                // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
                this.gl = this.canvas.getContext('webgl') || this.canvas.getContext('experimental-webgl');
                if (!this.gl) {
                    console.error('WebGLãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }

                // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚’è¨­å®š   
                this.gl.viewport(0, 0, width, height);

                // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
                this._onMouseMove = (e) => {
                    if (!this.mouse.isDown) return;
                    const pos = this._toGLCoords(e.clientX, e.clientY);
                    this.mouse.x = pos.x;
                    this.mouse.y = pos.y;
                };
                this._onMouseDown = (e) => {
                    const pos = this._toGLCoords(e.clientX, e.clientY);
                    this.mouse.x  = pos.x;
                    this.mouse.y  = pos.y;
                    this.mouse.lx = pos.x;
                    this.mouse.ly = pos.y;
                    this.mouse.isDown = true;
                };
                this._onMouseUp = (e) => {
                    this.mouse.isDown = false;
                };
                this._onMouseLeave = (e) => {
                    this.mouse.isDown = false;
                };
                this.canvas.addEventListener('mousemove',  this._onMouseMove);
                this.canvas.addEventListener('mousedown',  this._onMouseDown);
                this.canvas.addEventListener('mouseup',    this._onMouseUp);
                this.canvas.addEventListener('mouseleave', this._onMouseLeave);

                return this.canvas;
            }

            /**
             * @breaf è§£æ”¾å‡¦ç†
             */
            cleanup() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }

                if (this.program) {
                    if (this.gl) {
                        this.gl.deleteProgram(this.program);
                    }
                    this.program = null;
                }

                this.gl = null;

                // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è§£é™¤
                if (this.canvas) {
                    if (this._onMouseMove)  this.canvas.removeEventListener('mousemove',  this._onMouseMove);
                    if (this._onMouseDown)  this.canvas.removeEventListener('mousedown',  this._onMouseDown);
                    if (this._onMouseUp)    this.canvas.removeEventListener('mouseup',    this._onMouseUp);
                    if (this._onMouseLeave) this.canvas.removeEventListener('mouseleave', this._onMouseLeave);
                }
                this._onMouseMove = this._onMouseDown = this._onMouseUp = this._onMouseLeave = null;
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å‰Šé™¤
                if (this.canvas) {
                    if (this.canvas.parentNode) {
                        this.canvas.parentNode.removeChild(this.canvas);
                    }
                    this.canvas.remove();
                    this.canvas = null;
                }

                // ãƒã‚¦ã‚¹çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                this.mouse = {
                    x: 0, y: 0, lx: 0, ly: 0,
                    isDown: false, isPrevDown: false
                };

                this.frameCount = 0;
            }

            /**
             * @brief ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
             * @param   {number} type   ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã®ç¨®é¡ (VERTEX_SHADER or FRAGMENT_SHADER)
             * @param   {string} source ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
             * @returns {WebGLShader|null} ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
             */
            compileShader(type, source) {
                const shader = this.gl.createShader(type);
                this.gl.shaderSource(shader, source);
                this.gl.compileShader(shader);
                if (!this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)) {
                    const error = this.gl.getShaderInfoLog(shader);
                    this.gl.deleteShader(shader);
                    const shaderTypeName = type === this.gl.VERTEX_SHADER ? 'VERTEX' : 'FRAGMENT';
                    throw new Error(`${shaderTypeName}ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼:\n${error}`);
                }
                return shader;
            }

            /**
             * @brief GLSLãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã¦å®Ÿè¡Œ
             * @param   {string} fragmentSource ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
             * @returns {success: boolean, message: string} å®Ÿè¡Œçµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
             */
            execute(fragmentShaderSource) {
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    void main() {
                        gl_Position = vec4(a_position, 0.0, 1.0);
                    }
                `;

                try {
                    // ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
                    const vertexShader = this.compileShader(this.gl.VERTEX_SHADER, vertexShaderSource);
                    const fragmentShader = this.compileShader(this.gl.FRAGMENT_SHADER, fragmentShaderSource);

                    // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆ
                    this.program = this.gl.createProgram();
                    this.gl.attachShader(this.program, vertexShader);
                    this.gl.attachShader(this.program, fragmentShader);
                    this.gl.linkProgram(this.program);

                    if (!this.gl.getProgramParameter(this.program, this.gl.LINK_STATUS)) {
                        const error = this.gl.getProgramInfoLog(this.program);
                        throw new Error(`ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒªãƒ³ã‚¯ã‚¨ãƒ©ãƒ¼:\n${error}`);
                    }

                    this.gl.useProgram(this.program);

                    // é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ã‚’è¨­å®š(å…¨ç”»é¢ã‚’è¦†ã†å››è§’å½¢)
                    const positionBuffer = this.gl.createBuffer();
                    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, positionBuffer);
                    this.gl.bufferData(this.gl.ARRAY_BUFFER, new Float32Array([
                        -1, -1,
                         1, -1,
                        -1,  1,
                         1,  1,
                    ]), this.gl.STATIC_DRAW);

                    const positionLocation = this.gl.getAttribLocation(this.program, 'a_position');
                    this.gl.enableVertexAttribArray(positionLocation);
                    this.gl.vertexAttribPointer(positionLocation, 2, this.gl.FLOAT, false, 0, 0);

                    // ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ å¤‰æ•°ã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                    this.resolutionLocation = this.gl.getUniformLocation(this.program, 'iResolution');
                    this.mouseLocation = this.gl.getUniformLocation(this.program, 'iMouse');
                    this.timeLocation = this.gl.getUniformLocation(this.program, 'iTime');
                    this.frameLocation = this.gl.getUniformLocation(this.program, 'iFrame');

                    // æç”»é–‹å§‹
                    this.startTime = Date.now();
                    this.render();

                    return { success: true, message: 'GLSLå®Ÿè¡ŒæˆåŠŸ' };
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            /**
             * @brief æç”»ãƒ«ãƒ¼ãƒ—
             */
            render() {
                if (!this.program) { return; }

                // çµŒéæ™‚é–“ã‚’å–å¾—
                const currentTime = (Date.now() - this.startTime) / 1000.0;

                // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
                this.gl.clearColor(0.0, 0.0, 0.0, 1.0);
                this.gl.clear(this.gl.COLOR_BUFFER_BIT);

                // ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ å¤‰æ•°ã‚’è¨­å®š
                if (this.resolutionLocation) {
                    this.gl.uniform3f(this.resolutionLocation, this.canvas.width, this.canvas.height, 0);
                }
                if (this.mouseLocation) {
                    const isClick = this.mouse.isDown && !this.mouse.isPrevDown;
                    this.mouse.isPrevDown = this.mouse.isDown;
                    const m = this.mouse;
                    const lx = m.isDown ? Math.abs(m.lx) : -Math.abs(m.lx);
                    const ly = isClick  ? Math.abs(m.ly) : -Math.abs(m.lx);
                    this.gl.uniform4f(this.mouseLocation, m.x, m.y, lx, ly);
                }
                if (this.timeLocation) {
                    this.gl.uniform1f(this.timeLocation, currentTime);
                }
                if (this.frameLocation) {
                    this.gl.uniform1i(this.frameLocation, this.frameCount);
                }

                // æç”»
                this.gl.drawArrays(this.gl.TRIANGLE_STRIP, 0, 4);

                // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                this.animationId = requestAnimationFrame(() => this.render());
                this.frameCount++;
            }
        }

        // GLSLã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        window.glslEngine = new GLSLEngine();
    </script>

    <!-- ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script type="py">
        import io
        import base64
        import datetime
        import sys
        import traceback
        from io import StringIO
        from pyscript import document
        from pyscript import window

        # å®Ÿè¡Œå›æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        execution_count = 0

        def create_plot_image(base64_data, timestamp):
            """Pythonã®matplotã«ã‚ˆã‚‹ãƒ—ãƒ­ãƒƒãƒˆç”»åƒä½œæˆ"""

            global execution_count

            # divè¦ç´ ã‚’ä½œæˆ
            div_id = "user-plot-" + timestamp
            new_div = document.createElement("div")
            new_div.className = 'results-div'
            new_div.setAttribute("id", div_id)

            # ç”»åƒè¦ç´ ã‚’ä½œæˆ
            img = document.createElement("img")
            data_url = "data:img/png;base64," + base64_data
            img.setAttribute("src", data_url)
            img.setAttribute("style", "max-width: 100%; height: auto; border: 1px solid #ddd; borde-radius: 3px;")
            new_div.appendChild(img)

            # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¿½åŠ 
            results_area = document.querySelector("#results-area")
            results_area.appendChild(new_div)
            return div_id

        def create_glsl_canvas(canvas_element):
            """GLSLã‚­ãƒ£ãƒ³ãƒã‚¹è¡¨ç¤º"""

            # divè¦ç´ ã‚’ä½œæˆ
            new_div = document.createElement("div")
            new_div.className = 'results-div'

            new_div.appendChild(canvas_element)

            # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¿½åŠ 
            results_area = document.querySelector("#results-area")
            results_area.appendChild(new_div)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ©ç”¨ã§ãã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

        def show_plot(fig):
            """ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º"""

            buf = io.BytesIO()
            plt.figure(fig.number)
            plt.savefig(buf, format='png', dpi=100, bbox_inches='tight')
            buf.seek(0)
            img_str = base64.b64encode(buf.getvalue()).decode()

            timestamp = datetime.datetime.now().strftime("#%H%M%S")
            div_id = create_plot_image(img_str, timestamp)

        def clear_previous_outputs():
            """ä»¥å‰ã®ãƒ—ãƒ­ãƒƒãƒˆå‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢"""

            # çµæœã‚¨ãƒªã‚¢ã®å…¨ã¦ã®å­è¦ç´ ã‚’å‰Šé™¤
            results_area = document.querySelector("#results-area")
            if results_area:
                results_area.innerHTML = ""

        def execute_python_code():
            """Pythonã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ"""

            output_div = document.querySelector("#code-output")
            output_div.style.display = "block"
            if not output_div:
                return

            # CodeMirrorã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
            try:
                user_code = window.pythonEditor.getValue()
            except Exception as e:
                output_div.innerText = "ã‚¨ãƒ©ãƒ¼: CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
                return
            
            if not user_code.strip():
                output_div.innerText = "ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                return

            # ä»¥å‰ã®å‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢
            clear_previous_outputs()

            # å®Ÿè¡Œå›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
            global execution_count
            execution_count += 1
            output_div.innerText = "å®Ÿè¡Œä¸­... (#" + str(execution_count) + ")"

            # å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
            old_stdout = sys.stdout
            old_stderr = sys.stderr
            sys.stdout = StringIO()
            sys.stderr = StringIO()

            try:
                # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
                exec(user_code, globals())

                # æ¨™æº–å‡ºåŠ›ã‚’å–å¾—
                stdout_content = sys.stdout.getvalue()
                stderr_content = sys.stderr.getvalue()

                result = ""
                if stdout_content:
                    result += stdout_content
                if stderr_content:
                    result += "\nâŒ ã‚¨ãƒ©ãƒ¼:\n" + stdout_content
                if not stdout_content and not stderr_content:
                    result += "âœ… å®Ÿè¡Œå®Œäº† (å‡ºåŠ›ç„¡ã—)"

                output_div.innerText = result
            except Exception as e:
                # ãƒˆãƒ¬ãƒ¼ã‚¹ãƒãƒƒã‚¯æƒ…å ±ã‚’å–å¾—ã—ã¦ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã®è¡Œç•ªå·ã‚’è¡¨ç¤º
                error_traceback = traceback.format_exc()
                output_div.innerText = "âŒ ã‚¨ãƒ©ãƒ¼:\n" + error_traceback
            finally:
                # æ¨™æº–å‡ºåŠ›ã‚’å¾©å…ƒ
                sys.stdout = old_stdout
                sys.stderr = old_stderr

        def execute_glsl_code():
            """GLSLã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ"""

            output_div = document.querySelector("#code-output")
            if not output_div:
                return

            # CodeMirrorã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
            try:
                glsl_code = window.glslEditor.getValue()
            except Exception as e:
                output_div.innerText = "ã‚¨ãƒ©ãƒ¼: CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
                output_div.style.display = "block"
                return
            
            if not glsl_code.strip():
                output_div.innerText = "GLSLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                return

            # ä»¥å‰ã®å‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢
            clear_previous_outputs()

            try:
                # GLSLã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–
                canvas = window.glslEngine.init(512, 512)

                # GLSLã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
                result = window.glslEngine.execute(glsl_code)

                if result.success:
                    # æˆåŠŸã—ãŸå ´åˆã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’è¡¨ç¤º
                    create_glsl_canvas(canvas)
                    output_div.innerText = "âœ… GLSLå®Ÿè¡ŒæˆåŠŸ\nğŸ¨ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­..."
                    output_div.style.display = "none"
                else:
                    # ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                    output_div.innerText = "âŒ GLSLå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:\n" + result.message
                    output_div.style.display = "block"
            except Exception as e:
                output_div.innerText = "âŒ GLSLå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:\n" + str(e)
                output_div.style.display = "block"

        def execute_p5_code():
            """P5ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ"""

            output_div = document.querySelector("#code-output")
            if not output_div:
                return

            # CodeMirrorã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
            try:
                p5_code = window.p5Editor.getValue()
            except Exception as e:
                output_div.innerText = "ã‚¨ãƒ©ãƒ¼: CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
                output_div.style.display = "block"
                return

            # ä»¥å‰ã®å‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢
            clear_previous_outputs()

            results_area = document.querySelector("#results-area")

            # æ–°ã—ã„p5ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
            try:
                result = window.runP5Code(512, 512, p5_code)
                if result.success:
                    output_div.innerText = "âœ… P5å®Ÿè¡ŒæˆåŠŸ\nğŸ«Ÿ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­..."
                    output_div.style.display = "none"
                    results_area.style.display = "block"
                else:
                    output_div.innerText = "âŒ P5å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:\n" + result.message
                    output_div.style.display = "block"
                    results_area.style.display = "none"
            except Exception as e:
                output_div.innerText = "âŒ P5å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:\n" + str(e)
                output_div.style.display = "block"
                results_area.style.display = "none"

        def execute_user_code():
            """ç¾åœ¨é¸æŠä¸­ã®è¨€èªã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ"""

            current_lang = None

            # æ–¹æ³•1: dataå±æ€§ã‹ã‚‰å–å¾—
            try:
                current_lang = document.body.getAttribute('data-current-language')
                print(f"ãƒ‡ãƒ¼ã‚¿å±æ€§ã‹ã‚‰å–å¾—ã—ãŸè¨€èª: {current_lang}")
            except Exception as e:
                print(f"ãƒ‡ãƒ¼ã‚¿å±æ€§å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            
            # æ–¹æ³•2: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‹ã‚‰åˆ¤å®š
            if not current_lang:
                try:
                    python_tab = document.querySelector('#python-tab')
                    glsl_tab = document.querySelector('#glsl-tab')
                    p5_tab = document.querySelector('#p5-tab')
                    if python_tab and python_tab.classList.contains('active'):
                        current_lang = 'python'
                    elif glsl_tab and glsl_tab.classList.contains('active'):
                        current_lang = 'glsl'
                    elif p5_tab and p5_tab.classList.contains('active'):
                        current_lang = 'p5'
                    print(f"ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã‹ã‚‰åˆ¤å®šã—ãŸè¨€èª: {current_lang}")
                except Exception as e:
                    print(f"ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–åˆ¤å®šã‚¨ãƒ©ãƒ¼: {e}")
            
            if not current_lang:
                current_lang = 'python' # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

            print(f"å®Ÿè¡Œã™ã‚‹è¨€èª: {current_lang}")

            if current_lang == 'python':
                execute_python_code()
            elif current_lang == 'glsl':
                execute_glsl_code()
            else:
                execute_p5_code()

        # ãƒ—ãƒ­ã‚­ã‚·ä½œæˆã®ç‚ºã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        try:
            from pyscript.ffi import create_proxy
        except ImportError:
            try:
                from pyodide.ffi import create_proxy
            except ImportError:
                def create_proxy(func):
                    return func

        try:
            # Pyscriptæ¨å¥¨ã®@whenãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨
            from pyscript import when

            @when("click", "#execute-btn")
            def on_execute_click(event):
                """@whenãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©"""
                execute_user_code()
            print("âœ… @whenãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šã—ã¾ã—ãŸ")
        except Exception as e:
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: create_proxyã‚’ä½¿ç”¨
            execute_btn = document.querySelector("#execute-btn")
            if execute_btn:
                execute_btn.addEventListner("click", create_proxy(execute_user_code))
            print("âœ… create_proxyã§ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šã—ã¾ã—ãŸ")

        print("ğŸ‰ Python & GLSLå¯¾å¿œã®ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œç’°å¢ƒã®åˆæœŸåŒ–å®Œäº†!")
    </script>
</body>
</html>